<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Ferretería Ferremas - Ventas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
  <style>
    header, footer {
      background-color: #3209eb;
      color: #fff;
      padding: 1rem;
      text-align: center;
    }
    table {
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>Ferretería Ferremas</h1>
  </header>
  <div class="container my-4">
    <h2>Listado de Ventas</h2>
    <!-- Formulario de alta/modificación de venta -->
    <form id="ventaForm" class="mb-4">
      <input type="hidden" id="idPedido">
      <div class="row g-2">
        <div class="col">
          <input type="date" class="form-control" id="fechaPedido" placeholder="Fecha del Pedido" required>
        </div>
        <div class="col">
          <input type="number" class="form-control" id="total" placeholder="Total" required>
        </div>
        <div class="col">
          <input type="number" class="form-control" id="clienteIdCliente" placeholder="ID Cliente" required>
        </div>
        <div class="col">
          <button type="submit" class="btn btn-success" id="btnGuardarVenta">Guardar</button>
          <button type="button" class="btn btn-secondary" id="btnCancelarVenta" style="display:none;">Cancelar</button>
        </div>
      </div>
    </form>
    <table class="table table-striped table-bordered">
      <thead class="table-dark">
        <tr>
          <th>ID Pedido</th>
          <th>Fecha Pedido</th>
          <th>Total</th>
          <th>ID Cliente</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tabla-ventas">
        <!-- Se llenará con jQuery -->
      </tbody>
    </table>
  </div>
  <footer>
    <p>&copy; Grupo <b>FSJ</b> - 2025</p>
  </footer>
  <script>
    const apiUrl = "http://localhost:8282/sales";

    function cargarVentas() {
      $.get(apiUrl, function(data) {
        $('#tabla-ventas').empty();
        data.forEach(function(venta) {
          $('#tabla-ventas').append(`
            <tr>
              <td>${venta.idPedido}</td>
              <td>${venta.fechaPedido ? venta.fechaPedido.substring(0, 10) : ''}</td>
              <td>${venta.total}</td>
              <td>${venta.clienteIdCliente}</td>
              <td>
                <button class="btn btn-warning btn-sm btnEditarVenta" data-id="${venta.idPedido}">Editar</button>
                <button class="btn btn-danger btn-sm btnEliminarVenta" data-id="${venta.idPedido}">Eliminar</button>
              </td>
            </tr>
          `);
        });
      });
    }

    // Crear o actualizar venta
    $('#ventaForm').submit(function(e) {
      e.preventDefault();
      const venta = {
        idPedido: $('#idPedido').val() || null,
        fechaPedido: $('#fechaPedido').val(),
        total: $('#total').val(),
        clienteIdCliente: $('#clienteIdCliente').val()
      };
      $.ajax({
        url: apiUrl,
        method: "POST",
        contentType: "application/json",
        data: JSON.stringify(venta),
        success: function() {
          cargarVentas();
          $('#ventaForm')[0].reset();
          $('#idPedido').val('');
          $('#btnGuardarVenta').text('Guardar');
          $('#btnCancelarVenta').hide();
        },
        error: function() {
          alert("Error al guardar la venta.");
        }
      });
    });

    // Editar venta
    $(document).on('click', '.btnEditarVenta', function() {
      const id = $(this).data('id');
      $.get(apiUrl + '/' + id, function(venta) {
        $('#idPedido').val(venta.idPedido);
        $('#fechaPedido').val(venta.fechaPedido ? venta.fechaPedido.substring(0, 10) : '');
        $('#total').val(venta.total);
        $('#clienteIdCliente').val(venta.clienteIdCliente);
        $('#btnGuardarVenta').text('Actualizar');
        $('#btnCancelarVenta').show();
      });
    });

    // Cancelar edición
    $('#btnCancelarVenta').click(function() {
      $('#ventaForm')[0].reset();
      $('#idPedido').val('');
      $('#btnGuardarVenta').text('Guardar');
      $(this).hide();
    });

    // Eliminar venta
    $(document).on('click', '.btnEliminarVenta', function() {
      if (confirm("¿Seguro que deseas eliminar esta venta?")) {
        const id = $(this).data('id');
        $.ajax({
          url: apiUrl + '/' + id,
          method: 'DELETE',
          success: function() {
            cargarVentas();
          },
          error: function() {
            alert("Error al eliminar la venta.");
          }
        });
      }
    });

    // Inicializar
    $(document).ready(function () {
      cargarVentas();
      $('#btnCancelarVenta').hide();
    });
  </script>
</body>
</html>
